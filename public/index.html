<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data fetching</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
 integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
 crossorigin=""></script>
    <style>

        body {
            font-family: Inter;
        }

#novaMap {
        height: 380px;
      }

      table {
        border:1px solid grey;
      }
      body {
        max-width:1200px;
        margin:auto;
    }
    </style>
 
</head>
<body>

    <h1>Data fetching</h1>
    <h3>Data refreshes every 500ms</h3>

    <table>
      <tr><td>Device 1 Latitude: <span id="lat"></span>째</td></tr>
      <tr><td>Device 1 Longitude: <span id="lon"></span>째</td></tr>
      <tr><td>Device 2 Latitude: <span id="lat2"></span>째</td></tr>
      <tr><td>Device 2 Longitude: <span id="lon2"></span>째</td></tr>
      </table>

    <div id="novaMap"></div>

    <script >
          // Making a map and tiles
          const mymap = L.map('novaMap').setView([0, 0], 1);
      const attribution =
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
      
      const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      const tiles = L.tileLayer(tileUrl, {
          attribution
      });
      tiles.addTo(mymap);
      
      var latlngs = [];
      var latlngs2 = [];
      
      // Making a marker with a custom icon
      const issIcon = L.icon({
          iconUrl: 'https://cdn.shopify.com/s/files/1/0315/0587/5080/files/INCUS_logo_dark_140x.png?v=1643988183',
          iconSize: [50, 32],
          iconAnchor: [25, 16]
      });
      const issIcon2 = L.icon({
          iconUrl: 'https://cdn.shopify.com/s/files/1/0315/0587/5080/files/White_device_white_front_1_85f97b86-69cd-4fcd-bb79-420bce5047a6.png?v=1644771655',
          iconSize: [50, 32],
          iconAnchor: [25, 16]
      });
      const marker = L.marker([0, 0], {
          icon: issIcon
      }).addTo(mymap).bindPopup('INCUS athlete one')

      const marker2 = L.marker([0, 0], {
          icon: issIcon2
      }).addTo(mymap).bindPopup('INCUS athlete two')
      
      const api_url = 'https://www.incustrials.co.uk/getData.php';

   
      let deviceIds = [];

 
      
      async function getData() {
          const response = await fetch(api_url);
          const data = await response.json();

          //Get all device ids and store into an array
          deviceIds = [Object.keys(data.data.locations)];
          console.log(deviceIds);
         
          //get first device
           let firstDeviceId = deviceIds[0][0];
            console.log(firstDeviceId)
          //get last known data
          let firstDeviceLastMessage= firstDeviceId[ Object.keys(firstDeviceId).pop()];
        
          //get the lat
          let latitude = firstDeviceLastMessage.lat;
          let longitude = firstDeviceLastMessage.lon;
          console.log(latitude, longitude);

                   
          //get second device
          let secondDeviceId =  data.data.locations['ebbc58db232349ae'];
          //get last known data
          let secondDeviceLastMessage= secondDeviceId[ Object.keys(secondDeviceId).pop()];
          //get the lat
          let latitude2 = secondDeviceLastMessage.lat;
          let longitude2 = secondDeviceLastMessage.lon;
          console.log(latitude2, longitude2);

        

          marker.setLatLng([latitude, longitude]);
          document.getElementById('lat').textContent = latitude.toFixed(5);
          document.getElementById('lon').textContent = longitude.toFixed(5);
          document.getElementById('lat2').textContent = latitude2.toFixed(5);
          document.getElementById('lon2').textContent = longitude2.toFixed(5);


          marker2.setLatLng([latitude2, longitude2]);
    
      
         //   Incoming data array push to latlngs
          incomingCoords = [];
          incomingCoords.push(latitude, longitude);
          latlngs.push(incomingCoords);

          incomingCoords2 = [];
          incomingCoords2.push(latitude2, longitude2);
          latlngs2.push(incomingCoords2);
          
      
          // create a red polyline from an array of LatLng points
          var polyline = L.polyline(latlngs, {
              color: 'red'
          }).addTo(mymap);


          var polyline2 = L.polyline(latlngs2, {
              color: 'blue'
          }).addTo(mymap);

     

          // zoom the map to the polyline
         mymap.fitBounds(polyline2.getBounds());
      
      }
      
      
      
      getData();
      
      
      </script>





<script>


    // const api_url = 'https://www.incustrials.co.uk/getData.php'; 
        
    // async function fetchData() {
    //     let response = await fetch(api_url);
    //     let data = await response.json();
    //     console.log(data.data.locations)
    
    
    //     let firstDeviceId =  data.data.locations['af0325abb078f46'];
    //     let latestPosition = firstDeviceId[ Object.keys(firstDeviceId).pop()];
    //     console.log(latestPosition)
    
    
    //     let table = document.getElementById('myTable');
    
    
    //     // Append new table row for every device ID received.
    //     for (device in data.data.locations ){
    //         if (device != "mockServer"){
    //           console.log(device);
    //           let p = document.createElement('tr')
    //           p.textContent = device;
    //           table.append(p);
    //         }
    //     }
    // }
     
    //    setInterval(fetchData,1000);
    
    </script>
    
</body>
</html>